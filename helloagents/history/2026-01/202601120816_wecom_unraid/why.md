# 变更提案: 企业微信对接 Unraid 容器管理（MVP）

## 需求背景
家庭本地服务（以 Unraid 为核心）通常需要通过 Web 面板或 SSH 才能完成容器管理。为了降低日常运维门槛，计划实现一个统一中间层，将常用动作接入企业微信应用会话，并提供交互式卡片/按钮与可审计的执行结果回显。

## 产品分析

### 目标用户与场景
- **用户群体:** 个人用户（家庭运维的唯一管理员）
- **使用场景:** 外出/移动端仅有企业微信可用时，需要快速处理容器问题（重启/停止/更新）
- **核心痛点:** 多端登录、网络连通复杂（VPN/反代）、操作路径长且缺少统一审计

### 价值主张与成功指标
- **价值主张:** “在企业微信里用对话完成一次容器运维动作”，无需打开 Unraid 面板
- **成功指标（MVP）:**
  - 3 个动作可用：重启/停止/强制更新
  - 交互闭环：按钮选择动作 + 参数输入 + 二次确认 + 结果回显
  - 关键操作均产生日志（可追溯到用户与目标容器）

### 人文关怀
默认按“最小权限”与“最小暴露”设计：不在消息中回显敏感配置；对危险操作提供二次确认与明确告知。

## 变更内容
1. 企业微信自建应用回调：验签、解密、解析消息/事件与回复交互卡片
2. 统一命令路由与会话状态机：支持参数输入与确认流程
3. Unraid 适配器：实现容器重启/停止/强制更新并回显结果
4. 基础安全：用户白名单、输入校验、敏感信息保护、审计日志

## 影响范围
- **模块:** core / wecom / unraid
- **文件:** 预计新增 Go 服务端代码（`cmd/`、`internal/`）与部署文件（如 Dockerfile）
- **API:** `GET/POST /wecom/callback`，健康检查接口
- **数据:** 配置文件/环境变量；MVP 以“内存会话状态 + 日志”实现审计

## 核心场景

### 需求: Unraid 容器管理
**模块:** unraid
在企业微信应用会话中对指定容器执行常用运维动作，并回显执行结果。

#### 场景: 重启容器
用户在会话中选择“重启”，输入容器名，确认后系统执行重启并回显成功/失败原因与耗时。

#### 场景: 停止容器
用户在会话中选择“停止”，输入容器名，确认后系统执行停止并回显结果。

#### 场景: 强制更新容器
用户在会话中选择“强制更新”，输入容器名，确认后系统触发“更新并重建容器”的流程并回显结果。

### 需求: 安全与可追溯
**模块:** core
限制可用用户与危险操作，提供审计日志与错误可诊断性。

#### 场景: 非授权用户访问
未在白名单内的用户发起请求时，系统拒绝并提示无权限（不泄露内部信息）。

#### 场景: 输入不合法参数
用户输入包含非法字符或明显风险的容器名时，系统拒绝并提示规范输入。

## 风险评估
- **风险:** Unraid Connect 插件 GraphQL API 对“强制更新”的支持能力可能随版本变化（是否提供 update/pull/recreate 的 mutation）  
  **缓解:** 通过 GraphQL introspection 探测能力；实现“强制更新”时优先使用官方暴露的 mutation，若不支持则降级提示并给出可选替代方案（后续扩展）
- **风险:** 企业微信回调安全（签名/加解密）处理不当导致伪造请求  
  **缓解:** 严格验签与错误处理；仅允许 HTTPS 回调；限制来源与速率
